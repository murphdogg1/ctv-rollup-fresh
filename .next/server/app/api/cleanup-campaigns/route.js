"use strict";(()=>{var e={};e.id=781,e.ids=[781],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},2615:e=>{e.exports=require("http")},8791:e=>{e.exports=require("https")},8621:e=>{e.exports=require("punycode")},6162:e=>{e.exports=require("stream")},7360:e=>{e.exports=require("url")},1568:e=>{e.exports=require("zlib")},8532:(e,a,n)=>{n.r(a),n.d(a,{originalPathname:()=>m,patchFetch:()=>b,requestAsyncStorage:()=>g,routeModule:()=>p,serverHooks:()=>u,staticGenerationAsyncStorage:()=>d});var t={};n.r(t),n.d(t,{POST:()=>c});var o=n(9303),s=n(8716),i=n(670),r=n(7070),l=n(1926),_=n(6341);async function c(){try{console.log("=== CLEANUP CAMPAIGNS ===");let e={dbEngine:process.env.DB_ENGINE,hasSupabaseUrl:!!process.env.NEXT_PUBLIC_SUPABASE_URL,hasServiceKey:!!process.env.SUPABASE_SERVICE_ROLE_KEY,hasAnonKey:!!process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY,steps:[]};if("local"===process.env.DB_ENGINE)return console.log("Using local database for cleanup"),e.steps.push("Using local database"),await _.db.close(),e.steps.push("Local database cleared"),r.NextResponse.json({success:!0,message:"All campaigns deleted successfully (local database)",deletedCount:"all",debug:e});try{e.steps.push("Attempting Supabase cleanup");let a=(0,l.m)();e.steps.push("Supabase client created");let{count:n,error:t}=await a.from("campaigns").select("*",{count:"exact",head:!0});if(t)throw Error(`Failed to get campaign count: ${t.message}`);e.steps.push(`Found ${n} campaigns to delete`);let{error:o}=await a.from("campaigns").delete().neq("campaign_id","");if(o)throw Error(`Failed to delete campaigns: ${o.message}`);return e.steps.push("Campaigns deleted successfully"),console.log("Cleanup completed successfully"),r.NextResponse.json({success:!0,message:"All campaigns deleted successfully",deletedCount:n||0,debug:e})}catch(a){return console.warn("Supabase failed, falling back to local database:",a),e.steps.push(`Supabase failed: ${a.message}`),await _.db.close(),e.steps.push("Fallback to local database completed"),r.NextResponse.json({success:!0,message:"All campaigns deleted successfully (fallback to local database)",deletedCount:"all",debug:e})}}catch(e){return console.error("Cleanup error:",e),r.NextResponse.json({success:!1,error:e instanceof Error?e.message:"Unknown error",debug:{dbEngine:process.env.DB_ENGINE,hasSupabaseUrl:!!process.env.NEXT_PUBLIC_SUPABASE_URL,hasServiceKey:!!process.env.SUPABASE_SERVICE_ROLE_KEY,hasAnonKey:!!process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY}})}}let p=new o.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/cleanup-campaigns/route",pathname:"/api/cleanup-campaigns",filename:"route",bundlePath:"app/api/cleanup-campaigns/route"},resolvedPagePath:"/Users/mattmurphy/ctv-rollup-fresh/src/app/api/cleanup-campaigns/route.ts",nextConfigOutput:"",userland:t}),{requestAsyncStorage:g,staticGenerationAsyncStorage:d,serverHooks:u}=p,m="/api/cleanup-campaigns/route";function b(){return(0,i.patchFetch)({serverHooks:u,staticGenerationAsyncStorage:d})}},1926:(e,a,n)=>{n.d(a,{m:()=>i});var t=n(9498);let o=process.env.NEXT_PUBLIC_SUPABASE_URL,s=process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;o&&s&&(0,t.eI)(o,s);let i=()=>{let e=process.env.NEXT_PUBLIC_SUPABASE_URL,a=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!a)throw Error("Supabase environment variables not configured");return(0,t.eI)(e,a,{auth:{autoRefreshToken:!1,persistSession:!1}})}},6341:(e,a,n)=>{n.d(a,{db:()=>o}),global.__db_campaigns||(global.__db_campaigns=[],global.__db_campaign_uploads=[],global.__db_campaign_content_raw=[],global.__db_content_aliases=[],global.__db_genre_map=[],global.__db_initialized=!1);class t{constructor(){this.initializeDatabase()}async initializeDatabase(){try{global.__db_initialized?console.log("Database already initialized, reusing existing data"):(console.log("Initializing campaign-agnostic database..."),global.__db_initialized=!0,console.log("Database initialized successfully"))}catch(e){console.error("Database initialization error:",e)}}async createCampaign(e){if(!global.__db_initialized)throw Error("Database not yet initialized");let a=this.generateCampaignId(e),n={campaign_id:a,campaign_name:e,created_at:new Date};return global.__db_campaigns.push(n),console.log(`Created campaign: ${e} with ID: ${a}`),n}async getCampaigns(){return global.__db_initialized?(console.log(`Returning ${global.__db_campaigns.length} campaigns`),global.__db_campaigns.map(e=>({campaign_id:e.campaign_id,campaign_name:e.campaign_name,created_at:e.created_at}))):[]}async getCampaign(e){return global.__db_initialized&&global.__db_campaigns.find(a=>a.campaign_id===e)||null}async createCampaignUpload(e,a,n){if(!global.__db_initialized)throw Error("Database not yet initialized");let t={upload_id:this.generateUploadId(),campaign_id:e,filename:a,stored_path:n,uploaded_at:new Date};return global.__db_campaign_uploads.push(t),console.log(`Created upload for campaign ${e}: ${a}`),t}async getCampaignUploads(e){return global.__db_initialized?global.__db_campaign_uploads.filter(a=>a.campaign_id===e):[]}async insertCampaignContent(e){return global.__db_initialized?(global.__db_campaign_content_raw.push(...e),console.log(`Inserted ${e.length} content rows for campaign ${e[0]?.campaign_id}`),e.length):0}async upsertContentAlias(e,a){if(!global.__db_initialized)return;let n=global.__db_content_aliases.findIndex(a=>a.content_title_canon===e);n>=0?global.__db_content_aliases[n].content_key=a:global.__db_content_aliases.push({content_title_canon:e,content_key:a,created_at:new Date})}async upsertGenreMap(e,a){if(!global.__db_initialized)return;let n=global.__db_genre_map.findIndex(a=>a.raw_genre===e);n>=0?global.__db_genre_map[n].genre_canon=a:global.__db_genre_map.push({raw_genre:e,genre_canon:a,created_at:new Date})}generateAppRollup(e){if(!global.__db_initialized)return[];let a=e?global.__db_campaign_content_raw.filter(a=>a.campaign_id===e):global.__db_campaign_content_raw,n=new Map;for(let e of a){let a=e.content_network_name?.toLowerCase().trim()||"Unknown",t=`${e.campaign_id}-${a}`;n.has(t)||n.set(t,{campaign_id:e.campaign_id,app_name:e.content_network_name||"Unknown",impressions:0,completes:0,avg_vcr:0,content_count:0});let o=n.get(t);o.impressions+=e.impression||0,o.completes+=e.quartile100||0,o.content_count+=1}for(let e of Array.from(n.values()))e.avg_vcr=e.impressions>0?Math.round(e.completes/e.impressions*1e4)/100:0;let t=[],o=[];for(let e of Array.from(n.values()))e.impressions>=1e3?t.push(e):o.push(e);if(o.length>0){let a={campaign_id:e||"unknown",app_name:"Other",impressions:o.reduce((e,a)=>e+a.impressions,0),completes:o.reduce((e,a)=>e+a.completes,0),avg_vcr:0,content_count:o.reduce((e,a)=>e+a.content_count,0)};a.avg_vcr=a.impressions>0?Math.round(a.completes/a.impressions*1e4)/100:0,t.push(a)}return t.sort((e,a)=>a.impressions-e.impressions)}generateGenreRollup(e){if(!global.__db_initialized)return[];let a=e?global.__db_campaign_content_raw.filter(a=>a.campaign_id===e):global.__db_campaign_content_raw,n=new Map;for(let e of a){let a=this.getGenreCanon(e.content_network_name),t=`${e.campaign_id}-${a}`;n.has(t)||n.set(t,{campaign_id:e.campaign_id,genre_canon:a,impressions:0,completes:0,avg_vcr:0,content_count:0});let o=n.get(t);o.impressions+=e.impression||0,o.completes+=e.quartile100||0,o.content_count+=1}for(let e of Array.from(n.values()))e.avg_vcr=e.impressions>0?Math.round(e.completes/e.impressions*1e4)/100:0;return Array.from(n.values()).sort((e,a)=>a.impressions-e.impressions)}generateContentRollup(e){if(!global.__db_initialized)return[];let a=e?global.__db_campaign_content_raw.filter(a=>a.campaign_id===e):global.__db_campaign_content_raw,n=new Map;for(let e of a){let a=e.content_title||`${e.content_network_name} - Unknown Content`,t=this.getContentKey(a),o=e.content_network_name?.toLowerCase().trim()||"Unknown",s=`${e.campaign_id}-${t}-${o}`;n.has(s)||n.set(s,{campaign_id:e.campaign_id,content_key:t,content_title:a,content_network_name:e.content_network_name||"Unknown",impressions:0,completes:0,avg_vcr:0});let i=n.get(s);i.impressions+=e.impression||0,i.completes+=e.quartile100||0}for(let e of Array.from(n.values()))e.avg_vcr=e.impressions>0?Math.round(e.completes/e.impressions*1e4)/100:0;return Array.from(n.values()).sort((e,a)=>a.impressions-e.impressions)}generateCampaignId(e){let a=e.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,""),n=Math.random().toString(36).substring(2,8);return`${a}-${n}`}generateUploadId(){return`upload-${Date.now()}-${Math.random().toString(36).substring(2,8)}`}getContentKey(e){let a=e.toLowerCase().trim().replace(/[^a-z0-9 ]/g,""),n=global.__db_content_aliases.find(e=>e.content_title_canon===a);return n?.content_key||a}getGenreCanon(e){let a=global.__db_genre_map.find(a=>a.raw_genre===e);return a?.genre_canon||"Unknown"}getCampaignStats(e){global.__db_initialized;let a=global.__db_campaign_content_raw.filter(a=>a.campaign_id===e);a.reduce((e,a)=>e+(a.impression||0),0),a.reduce((e,a)=>e+(a.quartile100||0),0),new Set(a.map(e=>this.getGenreCanon(e.content_network_name))).size,a.length}async run(e,a=[]){if(!global.__db_initialized){console.log("Database not ready, query ignored:",e);return}console.log("Executing query:",e,"with params:",a)}async all(e,a=[]){return global.__db_initialized?console.log("Query ignored:",e):console.log("Database not ready, query ignored:",e),[]}async exec(e){if(!global.__db_initialized){console.log("Database not ready, query ignored:",e);return}console.log("Executing query:",e)}async close(){global.__db_campaigns=[],global.__db_campaign_uploads=[],global.__db_campaign_content_raw=[],global.__db_content_aliases=[],global.__db_genre_map=[],global.__db_initialized=!1}}let o=new t}};var a=require("../../../webpack-runtime.js");a.C(e);var n=e=>a(a.s=e),t=a.X(0,[948,972,498],()=>n(8532));module.exports=t})();