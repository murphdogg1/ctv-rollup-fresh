"use strict";(()=>{var e={};e.id=119,e.ids=[119],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4746:(e,n,a)=>{a.r(n),a.d(n,{originalPathname:()=>b,patchFetch:()=>m,requestAsyncStorage:()=>d,routeModule:()=>c,serverHooks:()=>g,staticGenerationAsyncStorage:()=>u});var t={};a.r(t),a.d(t,{GET:()=>p});var l=a(9303),_=a(8716),o=a(670),i=a(7070),r=a(6341),s=a(5174);async function p(){try{let e=(await r.db.all("SELECT * FROM rollup_content")).map(e=>s.BT.parse(e));return i.NextResponse.json(e)}catch(e){return console.error("Content rollup error:",e),i.NextResponse.json({error:"Failed to fetch content rollup data"},{status:500})}}let c=new l.AppRouteRouteModule({definition:{kind:_.x.APP_ROUTE,page:"/api/rollup/content/route",pathname:"/api/rollup/content",filename:"route",bundlePath:"app/api/rollup/content/route"},resolvedPagePath:"/Users/mattmurphy/ctv-rollup-fresh/src/app/api/rollup/content/route.ts",nextConfigOutput:"",userland:t}),{requestAsyncStorage:d,staticGenerationAsyncStorage:u,serverHooks:g}=c,b="/api/rollup/content/route";function m(){return(0,o.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:u})}},6341:(e,n,a)=>{a.d(n,{db:()=>l}),global.__db_campaigns||(global.__db_campaigns=[],global.__db_campaign_uploads=[],global.__db_campaign_content_raw=[],global.__db_content_aliases=[],global.__db_genre_map=[],global.__db_initialized=!1);class t{constructor(){this.initializeDatabase()}async initializeDatabase(){try{global.__db_initialized?console.log("Database already initialized, reusing existing data"):(console.log("Initializing campaign-agnostic database..."),global.__db_initialized=!0,console.log("Database initialized successfully"))}catch(e){console.error("Database initialization error:",e)}}async createCampaign(e){if(!global.__db_initialized)throw Error("Database not yet initialized");let n=this.generateCampaignId(e),a={campaign_id:n,campaign_name:e,created_at:new Date};return global.__db_campaigns.push(a),console.log(`Created campaign: ${e} with ID: ${n}`),a}async getCampaigns(){return global.__db_initialized?(console.log(`Returning ${global.__db_campaigns.length} campaigns`),global.__db_campaigns.map(e=>({campaign_id:e.campaign_id,campaign_name:e.campaign_name,created_at:e.created_at}))):[]}async getCampaign(e){return global.__db_initialized&&global.__db_campaigns.find(n=>n.campaign_id===e)||null}async createCampaignUpload(e,n,a){if(!global.__db_initialized)throw Error("Database not yet initialized");let t={upload_id:this.generateUploadId(),campaign_id:e,filename:n,stored_path:a,uploaded_at:new Date};return global.__db_campaign_uploads.push(t),console.log(`Created upload for campaign ${e}: ${n}`),t}async getCampaignUploads(e){return global.__db_initialized?global.__db_campaign_uploads.filter(n=>n.campaign_id===e):[]}async insertCampaignContent(e){return global.__db_initialized?(global.__db_campaign_content_raw.push(...e),console.log(`Inserted ${e.length} content rows for campaign ${e[0]?.campaign_id}`),e.length):0}async upsertContentAlias(e,n){if(!global.__db_initialized)return;let a=global.__db_content_aliases.findIndex(n=>n.content_title_canon===e);a>=0?global.__db_content_aliases[a].content_key=n:global.__db_content_aliases.push({content_title_canon:e,content_key:n,created_at:new Date})}async upsertGenreMap(e,n){if(!global.__db_initialized)return;let a=global.__db_genre_map.findIndex(n=>n.raw_genre===e);a>=0?global.__db_genre_map[a].genre_canon=n:global.__db_genre_map.push({raw_genre:e,genre_canon:n,created_at:new Date})}generateAppRollup(e){if(!global.__db_initialized)return[];let n=e?global.__db_campaign_content_raw.filter(n=>n.campaign_id===e):global.__db_campaign_content_raw,a=new Map;for(let e of n){let n=e.content_network_name?.toLowerCase().trim()||"Unknown",t=`${e.campaign_id}-${n}`;a.has(t)||a.set(t,{campaign_id:e.campaign_id,app_name:e.content_network_name||"Unknown",impressions:0,completes:0,avg_vcr:0,content_count:0});let l=a.get(t);l.impressions+=e.impression||0,l.completes+=e.quartile100||0,l.content_count+=1}for(let e of Array.from(a.values()))e.avg_vcr=e.impressions>0?Math.round(e.completes/e.impressions*1e4)/100:0;let t=[],l=[];for(let e of Array.from(a.values()))e.impressions>=1e3?t.push(e):l.push(e);if(l.length>0){let n={campaign_id:e||"unknown",app_name:"Other",impressions:l.reduce((e,n)=>e+n.impressions,0),completes:l.reduce((e,n)=>e+n.completes,0),avg_vcr:0,content_count:l.reduce((e,n)=>e+n.content_count,0)};n.avg_vcr=n.impressions>0?Math.round(n.completes/n.impressions*1e4)/100:0,t.push(n)}return t.sort((e,n)=>n.impressions-e.impressions)}generateGenreRollup(e){if(!global.__db_initialized)return[];let n=e?global.__db_campaign_content_raw.filter(n=>n.campaign_id===e):global.__db_campaign_content_raw,a=new Map;for(let e of n){let n=this.getGenreCanon(e.content_network_name),t=`${e.campaign_id}-${n}`;a.has(t)||a.set(t,{campaign_id:e.campaign_id,genre_canon:n,impressions:0,completes:0,avg_vcr:0,content_count:0});let l=a.get(t);l.impressions+=e.impression||0,l.completes+=e.quartile100||0,l.content_count+=1}for(let e of Array.from(a.values()))e.avg_vcr=e.impressions>0?Math.round(e.completes/e.impressions*1e4)/100:0;return Array.from(a.values()).sort((e,n)=>n.impressions-e.impressions)}generateContentRollup(e){if(!global.__db_initialized)return[];let n=e?global.__db_campaign_content_raw.filter(n=>n.campaign_id===e):global.__db_campaign_content_raw,a=new Map;for(let e of n){let n=e.content_title||`${e.content_network_name} - Unknown Content`,t=this.getContentKey(n),l=e.content_network_name?.toLowerCase().trim()||"Unknown",_=`${e.campaign_id}-${t}-${l}`;a.has(_)||a.set(_,{campaign_id:e.campaign_id,content_key:t,content_title:n,content_network_name:e.content_network_name||"Unknown",impressions:0,completes:0,avg_vcr:0});let o=a.get(_);o.impressions+=e.impression||0,o.completes+=e.quartile100||0}for(let e of Array.from(a.values()))e.avg_vcr=e.impressions>0?Math.round(e.completes/e.impressions*1e4)/100:0;return Array.from(a.values()).sort((e,n)=>n.impressions-e.impressions)}generateCampaignId(e){let n=e.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,""),a=Math.random().toString(36).substring(2,8);return`${n}-${a}`}generateUploadId(){return`upload-${Date.now()}-${Math.random().toString(36).substring(2,8)}`}getContentKey(e){let n=e.toLowerCase().trim().replace(/[^a-z0-9 ]/g,""),a=global.__db_content_aliases.find(e=>e.content_title_canon===n);return a?.content_key||n}getGenreCanon(e){let n=global.__db_genre_map.find(n=>n.raw_genre===e);return n?.genre_canon||"Unknown"}getCampaignStats(e){global.__db_initialized;let n=global.__db_campaign_content_raw.filter(n=>n.campaign_id===e);n.reduce((e,n)=>e+(n.impression||0),0),n.reduce((e,n)=>e+(n.quartile100||0),0),new Set(n.map(e=>this.getGenreCanon(e.content_network_name))).size,n.length}async run(e,n=[]){if(!global.__db_initialized){console.log("Database not ready, query ignored:",e);return}console.log("Executing query:",e,"with params:",n)}async all(e,n=[]){return global.__db_initialized?console.log("Query ignored:",e):console.log("Database not ready, query ignored:",e),[]}async exec(e){if(!global.__db_initialized){console.log("Database not ready, query ignored:",e);return}console.log("Executing query:",e)}async close(){global.__db_campaigns=[],global.__db_campaign_uploads=[],global.__db_campaign_content_raw=[],global.__db_content_aliases=[],global.__db_genre_map=[],global.__db_initialized=!1}}let l=new t},5174:(e,n,a)=>{a.d(n,{BT:()=>p,Do:()=>i,c9:()=>o,mC:()=>r,uF:()=>s,uV:()=>_,x_:()=>l});var t=a(1067);let l=t.Ry({event_timestamp:t.Z_().nullable(),app_bundle_raw:t.Z_().nullable(),app_name_raw:t.Z_().nullable(),publisher:t.Z_().nullable(),ssp:t.Z_().nullable(),dsp:t.Z_().nullable(),deal_id:t.Z_().nullable(),exchange_path:t.Z_().nullable(),impression_id:t.Z_().nullable(),request_id:t.Z_().nullable(),device_os:t.Z_().nullable(),device_make:t.Z_().nullable(),country:t.Z_().nullable(),currency:t.Z_().nullable(),price_paid:t.Rx().nullable(),fees_total:t.Rx().nullable(),ad_pod_id:t.Z_().nullable(),ad_break_id:t.Z_().nullable(),ad_position:t.Rx().nullable(),content_id_raw:t.Z_().nullable(),content_title_raw:t.Z_().nullable(),content_episode_raw:t.Z_().nullable(),content_genre_raw:t.Z_().nullable(),channel_name_raw:t.Z_().nullable(),duration_sec:t.Rx().nullable(),vtr:t.Rx().nullable(),viewable:t.O7().nullable()});l.extend({app_bundle:t.Z_().nullable(),app_name:t.Z_().nullable(),publisher_norm:t.Z_().nullable(),app_bundle_status:t.Km(["mapped","unmapped"]),content_title_canon:t.Z_().nullable(),content_key:t.Z_().nullable(),genre_canon:t.Z_().nullable()}).extend({dedup_tier:t.Rx(),dedup_reason:t.Z_()});let _=t.Ry({raw:t.Z_(),app_bundle:t.Z_(),app_name:t.Z_(),publisher:t.Z_(),mask_reason:t.Z_().nullable()}),o=t.Ry({raw:t.Z_(),genre_canon:t.Z_()}),i=t.Ry({content_title_canon:t.Z_(),content_key:t.Z_()}),r=t.Ry({app_bundle:t.Z_().nullable(),app_name:t.Z_().nullable(),impressions:t.Rx(),spend:t.Rx().nullable(),avg_vtr:t.Rx().nullable(),viewable_rate:t.Rx().nullable(),unique_ssps:t.Rx(),unique_dsps:t.Rx(),unique_deal_paths:t.Rx()}),s=t.Ry({genre_canon:t.Z_().nullable(),impressions:t.Rx(),spend:t.Rx().nullable(),avg_vtr:t.Rx().nullable(),viewable_rate:t.Rx().nullable(),unique_ssps:t.Rx(),unique_dsps:t.Rx(),unique_deal_paths:t.Rx()}),p=t.Ry({content_key:t.Z_().nullable(),content_title_canon:t.Z_().nullable(),app_bundle:t.Z_().nullable(),impressions:t.Rx(),spend:t.Rx().nullable(),avg_vtr:t.Rx().nullable(),viewable_rate:t.Rx().nullable(),unique_ssps:t.Rx(),unique_dsps:t.Rx(),unique_deal_paths:t.Rx()});t.Ry({success:t.O7(),rowsInserted:t.Rx(),detectedColumns:t.IX(t.Z_()),sampleRows:t.IX(l),warnings:t.IX(t.Z_()).optional()}),t.Ry({connected:t.O7(),engine:t.Z_(),rowCounts:t.Ry({raw_events:t.Rx(),bundle_map:t.Rx(),genre_map:t.Rx(),content_aliases:t.Rx()})})}};var n=require("../../../../webpack-runtime.js");n.C(e);var a=e=>n(n.s=e),t=n.X(0,[948,972,67],()=>a(4746));module.exports=t})();