"use strict";(()=>{var e={};e.id=166,e.ids=[166],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},7458:(e,a,n)=>{n.r(a),n.d(a,{originalPathname:()=>b,patchFetch:()=>m,requestAsyncStorage:()=>u,routeModule:()=>d,serverHooks:()=>g,staticGenerationAsyncStorage:()=>c});var l={};n.r(l),n.d(l,{POST:()=>p});var t=n(9303),_=n(8716),i=n(670),o=n(7070),r=n(6341),s=n(5174);async function p(e){try{let{bundles:a}=await e.json();if(!Array.isArray(a))return o.NextResponse.json({error:"Bundles array is required"},{status:400});let n=a.map(e=>s.uV.parse(e));for(let e of n)await r.db.run(`
        INSERT INTO bundle_map (raw, app_bundle, app_name, publisher, mask_reason)
        VALUES (?, ?, ?, ?, ?)
        ON CONFLICT (raw) DO UPDATE SET
          app_bundle = EXCLUDED.app_bundle,
          app_name = EXCLUDED.app_name,
          publisher = EXCLUDED.publisher,
          mask_reason = EXCLUDED.mask_reason
      `,[e.raw,e.app_bundle,e.app_name,e.publisher,e.mask_reason]);return o.NextResponse.json({success:!0,updated:n.length})}catch(e){return console.error("Bundle mapping error:",e),o.NextResponse.json({error:"Failed to update bundle mappings"},{status:500})}}let d=new t.AppRouteRouteModule({definition:{kind:_.x.APP_ROUTE,page:"/api/map/bundles/route",pathname:"/api/map/bundles",filename:"route",bundlePath:"app/api/map/bundles/route"},resolvedPagePath:"/Users/mattmurphy/ctv-rollup/src/app/api/map/bundles/route.ts",nextConfigOutput:"",userland:l}),{requestAsyncStorage:u,staticGenerationAsyncStorage:c,serverHooks:g}=d,b="/api/map/bundles/route";function m(){return(0,i.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:c})}},6341:(e,a,n)=>{n.d(a,{db:()=>t}),global.__db_campaigns||(global.__db_campaigns=[],global.__db_campaign_uploads=[],global.__db_campaign_content_raw=[],global.__db_content_aliases=[],global.__db_genre_map=[],global.__db_initialized=!1);class l{constructor(){this.initializeDatabase()}async initializeDatabase(){try{global.__db_initialized?console.log("Database already initialized, reusing existing data"):(console.log("Initializing campaign-agnostic database..."),global.__db_initialized=!0,console.log("Database initialized successfully"))}catch(e){console.error("Database initialization error:",e)}}async createCampaign(e){if(!global.__db_initialized)throw Error("Database not yet initialized");let a=this.generateCampaignId(e),n={campaign_id:a,campaign_name:e,created_at:new Date};return global.__db_campaigns.push(n),console.log(`Created campaign: ${e} with ID: ${a}`),n}async getCampaigns(){return global.__db_initialized?(console.log(`Returning ${global.__db_campaigns.length} campaigns`),global.__db_campaigns.map(e=>({campaign_id:e.campaign_id,campaign_name:e.campaign_name,created_at:e.created_at}))):[]}async getCampaign(e){return global.__db_initialized&&global.__db_campaigns.find(a=>a.campaign_id===e)||null}async createCampaignUpload(e,a,n){if(!global.__db_initialized)throw Error("Database not yet initialized");let l={upload_id:this.generateUploadId(),campaign_id:e,filename:a,stored_path:n,uploaded_at:new Date};return global.__db_campaign_uploads.push(l),console.log(`Created upload for campaign ${e}: ${a}`),l}async getCampaignUploads(e){return global.__db_initialized?global.__db_campaign_uploads.filter(a=>a.campaign_id===e):[]}async insertCampaignContent(e){return global.__db_initialized?(global.__db_campaign_content_raw.push(...e),console.log(`Inserted ${e.length} content rows for campaign ${e[0]?.campaign_id}`),e.length):0}async upsertContentAlias(e,a){if(!global.__db_initialized)return;let n=global.__db_content_aliases.findIndex(a=>a.content_title_canon===e);n>=0?global.__db_content_aliases[n].content_key=a:global.__db_content_aliases.push({content_title_canon:e,content_key:a,created_at:new Date})}async upsertGenreMap(e,a){if(!global.__db_initialized)return;let n=global.__db_genre_map.findIndex(a=>a.raw_genre===e);n>=0?global.__db_genre_map[n].genre_canon=a:global.__db_genre_map.push({raw_genre:e,genre_canon:a,created_at:new Date})}generateAppRollup(e){if(!global.__db_initialized)return[];let a=e?global.__db_campaign_content_raw.filter(a=>a.campaign_id===e):global.__db_campaign_content_raw,n=new Map;for(let e of a){let a=e.content_network_name?.toLowerCase().trim()||"Unknown",l=`${e.campaign_id}-${a}`;n.has(l)||n.set(l,{campaign_id:e.campaign_id,app_name:e.content_network_name||"Unknown",impressions:0,completes:0,avg_vcr:0,content_count:0});let t=n.get(l);t.impressions+=e.impression||0,t.completes+=e.quartile100||0,t.content_count+=1}for(let e of Array.from(n.values()))e.avg_vcr=e.impressions>0?Math.round(e.completes/e.impressions*1e4)/100:0;let l=[],t=[];for(let e of Array.from(n.values()))e.impressions>=1e3?l.push(e):t.push(e);if(t.length>0){let a={campaign_id:e||"unknown",app_name:"Other",impressions:t.reduce((e,a)=>e+a.impressions,0),completes:t.reduce((e,a)=>e+a.completes,0),avg_vcr:0,content_count:t.reduce((e,a)=>e+a.content_count,0)};a.avg_vcr=a.impressions>0?Math.round(a.completes/a.impressions*1e4)/100:0,l.push(a)}return l.sort((e,a)=>a.impressions-e.impressions)}generateGenreRollup(e){if(!global.__db_initialized)return[];let a=e?global.__db_campaign_content_raw.filter(a=>a.campaign_id===e):global.__db_campaign_content_raw,n=new Map;for(let e of a){let a=this.getGenreCanon(e.content_network_name),l=`${e.campaign_id}-${a}`;n.has(l)||n.set(l,{campaign_id:e.campaign_id,genre_canon:a,impressions:0,completes:0,avg_vcr:0,content_count:0});let t=n.get(l);t.impressions+=e.impression||0,t.completes+=e.quartile100||0,t.content_count+=1}for(let e of Array.from(n.values()))e.avg_vcr=e.impressions>0?Math.round(e.completes/e.impressions*1e4)/100:0;return Array.from(n.values()).sort((e,a)=>a.impressions-e.impressions)}generateContentRollup(e){if(!global.__db_initialized)return[];let a=e?global.__db_campaign_content_raw.filter(a=>a.campaign_id===e):global.__db_campaign_content_raw,n=new Map;for(let e of a){let a=e.content_title||`${e.content_network_name} - Unknown Content`,l=this.getContentKey(a),t=e.content_network_name?.toLowerCase().trim()||"Unknown",_=`${e.campaign_id}-${l}-${t}`;n.has(_)||n.set(_,{campaign_id:e.campaign_id,content_key:l,content_title:a,content_network_name:e.content_network_name||"Unknown",impressions:0,completes:0,avg_vcr:0});let i=n.get(_);i.impressions+=e.impression||0,i.completes+=e.quartile100||0}for(let e of Array.from(n.values()))e.avg_vcr=e.impressions>0?Math.round(e.completes/e.impressions*1e4)/100:0;return Array.from(n.values()).sort((e,a)=>a.impressions-e.impressions)}generateCampaignId(e){let a=e.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,""),n=Math.random().toString(36).substring(2,8);return`${a}-${n}`}generateUploadId(){return`upload-${Date.now()}-${Math.random().toString(36).substring(2,8)}`}getContentKey(e){let a=e.toLowerCase().trim().replace(/[^a-z0-9 ]/g,""),n=global.__db_content_aliases.find(e=>e.content_title_canon===a);return n?.content_key||a}getGenreCanon(e){let a=global.__db_genre_map.find(a=>a.raw_genre===e);return a?.genre_canon||"Unknown"}getCampaignStats(e){global.__db_initialized;let a=global.__db_campaign_content_raw.filter(a=>a.campaign_id===e);a.reduce((e,a)=>e+(a.impression||0),0),a.reduce((e,a)=>e+(a.quartile100||0),0),new Set(a.map(e=>this.getGenreCanon(e.content_network_name))).size,a.length}async run(e,a=[]){if(!global.__db_initialized){console.log("Database not ready, query ignored:",e);return}console.log("Executing query:",e,"with params:",a)}async all(e,a=[]){return global.__db_initialized?console.log("Query ignored:",e):console.log("Database not ready, query ignored:",e),[]}async exec(e){if(!global.__db_initialized){console.log("Database not ready, query ignored:",e);return}console.log("Executing query:",e)}async close(){global.__db_campaigns=[],global.__db_campaign_uploads=[],global.__db_campaign_content_raw=[],global.__db_content_aliases=[],global.__db_genre_map=[],global.__db_initialized=!1}}let t=new l},5174:(e,a,n)=>{n.d(a,{BT:()=>p,Do:()=>o,c9:()=>i,mC:()=>r,uF:()=>s,uV:()=>_,x_:()=>t});var l=n(1067);let t=l.Ry({event_timestamp:l.Z_().nullable(),app_bundle_raw:l.Z_().nullable(),app_name_raw:l.Z_().nullable(),publisher:l.Z_().nullable(),ssp:l.Z_().nullable(),dsp:l.Z_().nullable(),deal_id:l.Z_().nullable(),exchange_path:l.Z_().nullable(),impression_id:l.Z_().nullable(),request_id:l.Z_().nullable(),device_os:l.Z_().nullable(),device_make:l.Z_().nullable(),country:l.Z_().nullable(),currency:l.Z_().nullable(),price_paid:l.Rx().nullable(),fees_total:l.Rx().nullable(),ad_pod_id:l.Z_().nullable(),ad_break_id:l.Z_().nullable(),ad_position:l.Rx().nullable(),content_id_raw:l.Z_().nullable(),content_title_raw:l.Z_().nullable(),content_episode_raw:l.Z_().nullable(),content_genre_raw:l.Z_().nullable(),channel_name_raw:l.Z_().nullable(),duration_sec:l.Rx().nullable(),vtr:l.Rx().nullable(),viewable:l.O7().nullable()});t.extend({app_bundle:l.Z_().nullable(),app_name:l.Z_().nullable(),publisher_norm:l.Z_().nullable(),app_bundle_status:l.Km(["mapped","unmapped"]),content_title_canon:l.Z_().nullable(),content_key:l.Z_().nullable(),genre_canon:l.Z_().nullable()}).extend({dedup_tier:l.Rx(),dedup_reason:l.Z_()});let _=l.Ry({raw:l.Z_(),app_bundle:l.Z_(),app_name:l.Z_(),publisher:l.Z_(),mask_reason:l.Z_().nullable()}),i=l.Ry({raw:l.Z_(),genre_canon:l.Z_()}),o=l.Ry({content_title_canon:l.Z_(),content_key:l.Z_()}),r=l.Ry({app_bundle:l.Z_().nullable(),app_name:l.Z_().nullable(),impressions:l.Rx(),spend:l.Rx().nullable(),avg_vtr:l.Rx().nullable(),viewable_rate:l.Rx().nullable(),unique_ssps:l.Rx(),unique_dsps:l.Rx(),unique_deal_paths:l.Rx()}),s=l.Ry({genre_canon:l.Z_().nullable(),impressions:l.Rx(),spend:l.Rx().nullable(),avg_vtr:l.Rx().nullable(),viewable_rate:l.Rx().nullable(),unique_ssps:l.Rx(),unique_dsps:l.Rx(),unique_deal_paths:l.Rx()}),p=l.Ry({content_key:l.Z_().nullable(),content_title_canon:l.Z_().nullable(),app_bundle:l.Z_().nullable(),impressions:l.Rx(),spend:l.Rx().nullable(),avg_vtr:l.Rx().nullable(),viewable_rate:l.Rx().nullable(),unique_ssps:l.Rx(),unique_dsps:l.Rx(),unique_deal_paths:l.Rx()});l.Ry({success:l.O7(),rowsInserted:l.Rx(),detectedColumns:l.IX(l.Z_()),sampleRows:l.IX(t),warnings:l.IX(l.Z_()).optional()}),l.Ry({connected:l.O7(),engine:l.Z_(),rowCounts:l.Ry({raw_events:l.Rx(),bundle_map:l.Rx(),genre_map:l.Rx(),content_aliases:l.Rx()})})}};var a=require("../../../../webpack-runtime.js");a.C(e);var n=e=>a(a.s=e),l=a.X(0,[948,972,67],()=>n(7458));module.exports=l})();