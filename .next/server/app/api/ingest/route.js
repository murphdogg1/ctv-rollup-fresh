"use strict";(()=>{var e={};e.id=124,e.ids=[124],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},5315:e=>{e.exports=require("path")},6162:e=>{e.exports=require("stream")},5942:(e,n,l)=>{l.r(n),l.d(n,{originalPathname:()=>g,patchFetch:()=>h,requestAsyncStorage:()=>R,routeModule:()=>m,serverHooks:()=>Z,staticGenerationAsyncStorage:()=>x});var a={};l.r(a),l.d(a,{POST:()=>c});var t=l(9303),r=l(8716),s=l(670),u=l(7070);let i=require("fs");var o=l(5315),_=l.n(o),p=l(7367),d=l.n(p),b=l(5174);async function c(e){try{let n=(await e.formData()).getAll("files");if(!n||0===n.length)return u.NextResponse.json({error:"No files provided"},{status:400});let l=0,a=new Set,t=[],r=[];for(let e of n){let n=process.env.UPLOAD_DIR||"./uploads";await i.promises.mkdir(n,{recursive:!0});let s=_().join(n,e.name),u=await e.arrayBuffer(),o=Buffer.from(u);await i.promises.writeFile(s,o);let p=0,b=[],c=[];if(e.name.toLowerCase().endsWith(".csv")){let n=o.toString("utf-8"),l=d().parse(n,{header:!0,skipEmptyLines:!0});l.errors.length>0&&r.push(`CSV parsing errors in ${e.name}: ${l.errors.length} errors`),b=l.meta.fields||[];let a=l.data;a.length>0&&(p=a.length,c=a.slice(0,5))}else if(e.name.toLowerCase().endsWith(".parquet")){r.push(`Parquet files not supported in demo mode: ${e.name}`);continue}l+=p,b.forEach(e=>a.add(e)),t.push(...c),await i.promises.unlink(s)}let s=t.slice(0,5).map(e=>{try{return b.x_.parse(e)}catch(n){return r.push(`Row validation error: ${n}`),e}}),o={success:!0,rowsInserted:l,detectedColumns:Array.from(a),sampleRows:s,warnings:r.length>0?r:void 0};return u.NextResponse.json(o)}catch(e){return console.error("Ingest error:",e),u.NextResponse.json({error:"Failed to ingest files",details:e instanceof Error?e.message:"Unknown error"},{status:500})}}let m=new t.AppRouteRouteModule({definition:{kind:r.x.APP_ROUTE,page:"/api/ingest/route",pathname:"/api/ingest",filename:"route",bundlePath:"app/api/ingest/route"},resolvedPagePath:"/Users/mattmurphy/ctv-rollup/src/app/api/ingest/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:R,staticGenerationAsyncStorage:x,serverHooks:Z}=m,g="/api/ingest/route";function h(){return(0,s.patchFetch)({serverHooks:Z,staticGenerationAsyncStorage:x})}},5174:(e,n,l)=>{l.d(n,{BT:()=>_,Do:()=>u,c9:()=>s,mC:()=>i,uF:()=>o,uV:()=>r,x_:()=>t});var a=l(1067);let t=a.Ry({event_timestamp:a.Z_().nullable(),app_bundle_raw:a.Z_().nullable(),app_name_raw:a.Z_().nullable(),publisher:a.Z_().nullable(),ssp:a.Z_().nullable(),dsp:a.Z_().nullable(),deal_id:a.Z_().nullable(),exchange_path:a.Z_().nullable(),impression_id:a.Z_().nullable(),request_id:a.Z_().nullable(),device_os:a.Z_().nullable(),device_make:a.Z_().nullable(),country:a.Z_().nullable(),currency:a.Z_().nullable(),price_paid:a.Rx().nullable(),fees_total:a.Rx().nullable(),ad_pod_id:a.Z_().nullable(),ad_break_id:a.Z_().nullable(),ad_position:a.Rx().nullable(),content_id_raw:a.Z_().nullable(),content_title_raw:a.Z_().nullable(),content_episode_raw:a.Z_().nullable(),content_genre_raw:a.Z_().nullable(),channel_name_raw:a.Z_().nullable(),duration_sec:a.Rx().nullable(),vtr:a.Rx().nullable(),viewable:a.O7().nullable()});t.extend({app_bundle:a.Z_().nullable(),app_name:a.Z_().nullable(),publisher_norm:a.Z_().nullable(),app_bundle_status:a.Km(["mapped","unmapped"]),content_title_canon:a.Z_().nullable(),content_key:a.Z_().nullable(),genre_canon:a.Z_().nullable()}).extend({dedup_tier:a.Rx(),dedup_reason:a.Z_()});let r=a.Ry({raw:a.Z_(),app_bundle:a.Z_(),app_name:a.Z_(),publisher:a.Z_(),mask_reason:a.Z_().nullable()}),s=a.Ry({raw:a.Z_(),genre_canon:a.Z_()}),u=a.Ry({content_title_canon:a.Z_(),content_key:a.Z_()}),i=a.Ry({app_bundle:a.Z_().nullable(),app_name:a.Z_().nullable(),impressions:a.Rx(),spend:a.Rx().nullable(),avg_vtr:a.Rx().nullable(),viewable_rate:a.Rx().nullable(),unique_ssps:a.Rx(),unique_dsps:a.Rx(),unique_deal_paths:a.Rx()}),o=a.Ry({genre_canon:a.Z_().nullable(),impressions:a.Rx(),spend:a.Rx().nullable(),avg_vtr:a.Rx().nullable(),viewable_rate:a.Rx().nullable(),unique_ssps:a.Rx(),unique_dsps:a.Rx(),unique_deal_paths:a.Rx()}),_=a.Ry({content_key:a.Z_().nullable(),content_title_canon:a.Z_().nullable(),app_bundle:a.Z_().nullable(),impressions:a.Rx(),spend:a.Rx().nullable(),avg_vtr:a.Rx().nullable(),viewable_rate:a.Rx().nullable(),unique_ssps:a.Rx(),unique_dsps:a.Rx(),unique_deal_paths:a.Rx()});a.Ry({success:a.O7(),rowsInserted:a.Rx(),detectedColumns:a.IX(a.Z_()),sampleRows:a.IX(t),warnings:a.IX(a.Z_()).optional()}),a.Ry({connected:a.O7(),engine:a.Z_(),rowCounts:a.Ry({raw_events:a.Rx(),bundle_map:a.Rx(),genre_map:a.Rx(),content_aliases:a.Rx()})})}};var n=require("../../../webpack-runtime.js");n.C(e);var l=e=>n(n.s=e),a=n.X(0,[948,972,67,367],()=>l(5942));module.exports=a})();