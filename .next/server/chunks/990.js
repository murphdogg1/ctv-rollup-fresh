"use strict";exports.id=990,exports.ids=[990],exports.modules={8990:(e,a,t)=>{t.d(a,{k:()=>r});var n=t(1926),i=t(6341);class r{static async createCampaign(e){try{if("local"===process.env.DB_ENGINE){let a=await i.db.createCampaign(e);return{campaign_id:a.campaign_id,campaign_name:a.campaign_name,created_at:a.created_at.toISOString()}}let a=(0,n.m)(),t=this.generateCampaignId(e),{data:r,error:o}=await a.from("campaigns").insert({campaign_id:t,campaign_name:e}).select().single();if(o)throw Error(`Failed to create campaign: ${o.message}`);return r}catch(e){throw Error(`Database service not available: ${e}`)}}static async getCampaigns(){try{if("local"===process.env.DB_ENGINE)return await i.db.getCampaigns();let e=(0,n.m)(),{data:a,error:t}=await e.from("campaigns").select("*").order("created_at",{ascending:!1});if(t)throw Error(`Failed to fetch campaigns: ${t.message}`);return a||[]}catch(e){return console.warn("Database service not available:",e),[]}}static async getCampaignById(e){try{if("local"===process.env.DB_ENGINE)return await i.db.getCampaign(e);let a=(0,n.m)(),{data:t,error:r}=await a.from("campaigns").select("*").eq("campaign_id",e).single();if(r&&"PGRST116"!==r.code)throw Error(`Failed to fetch campaign: ${r.message}`);return t}catch(e){return console.warn("Database service not available:",e),null}}static async createCampaignUpload(e,a,t){try{if("local"===process.env.DB_ENGINE){let n=await i.db.createCampaignUpload(e,a,t);return{upload_id:n.upload_id,campaign_id:e,file_name:n.filename,stored_path:n.stored_path,uploaded_at:n.uploaded_at.toISOString()}}let r=(0,n.m)(),o=this.generateUploadId();console.log("Inserting upload record with:",{upload_id:o,campaign_id:e,file_name:a,stored_path:t});let{data:l,error:s}=await r.from("campaign_uploads").insert({upload_id:o,campaign_id:e,file_name:a,stored_path:t}).select().single();if(s)throw Error(`Failed to create upload record: ${s.message}`);return l}catch(e){throw Error(`Database service not available: ${e}`)}}static async insertContentData(e){try{if("local"===process.env.DB_ENGINE){let a=e.map(e=>({campaign_id:e.campaign_id,campaign_name_src:e.campaign_name_src,content_title:e.content_title,content_network_name:e.content_network_name,impression:e.impression,quartile100:e.quartile100}));await i.db.insertCampaignContent(a);return}let a=(0,n.m)(),{error:t}=await a.from("campaign_content_raw").insert(e);if(t)throw Error(`Failed to insert content data: ${t.message}`)}catch(e){throw Error(`Database service not available: ${e}`)}}static async getContentData(e){try{let a=(0,n.m)().from("campaign_content_raw").select("*");e&&(a=a.eq("campaign_id",e));let{data:t,error:i}=await a;if(i)throw Error(`Failed to fetch content data: ${i.message}`);return t||[]}catch(e){return console.warn("Database service not available:",e),[]}}static async getAppRollup(e){try{let a=(0,n.m)().from("rr_rollup_app").select("*");e&&(a=a.eq("campaign_id",e));let{data:t,error:i}=await a.order("impressions",{ascending:!1});if(i)throw Error(`Failed to fetch app rollup: ${i.message}`);return t||[]}catch(e){return console.warn("Database service not available:",e),[]}}static async getGenreRollup(e){try{let a=(0,n.m)().from("rr_rollup_genre").select("*");e&&(a=a.eq("campaign_id",e));let{data:t,error:i}=await a.order("impressions",{ascending:!1});if(i)throw Error(`Failed to fetch genre rollup: ${i.message}`);return t||[]}catch(e){return console.warn("Database service not available:",e),[]}}static async getContentRollup(e){try{let a=(0,n.m)().from("rr_rollup_content").select("*");e&&(a=a.eq("campaign_id",e));let{data:t,error:i}=await a.order("impressions",{ascending:!1});if(i)throw Error(`Failed to fetch content rollup: ${i.message}`);return t||[]}catch(e){return console.warn("Database service not available:",e),[]}}static async getRowCounts(){try{let e=(0,n.m)(),[a,t,i,r,o]=await Promise.all([this.getCampaigns(),e.from("campaign_uploads").select("id",{count:"exact"}),this.getContentData(),e.from("content_aliases").select("id",{count:"exact"}),e.from("genre_map").select("id",{count:"exact"})]);return{campaigns:a.length,campaign_uploads:t.count||0,content_aliases:r.count||0,genre_map:o.count||0}}catch(e){return console.warn("Database service not available:",e),{campaigns:0,campaign_uploads:0,content_aliases:0,genre_map:0}}}static generateUploadId(){return`upload-${Date.now()}-${Math.random().toString(36).substring(2,8)}`}static generateCampaignId(e){let a=e.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,""),t=Math.random().toString(36).substring(2,8);return`${a}-${t}`}}},1926:(e,a,t)=>{t.d(a,{m:()=>o});var n=t(9498);let i=process.env.NEXT_PUBLIC_SUPABASE_URL,r=process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;i&&r&&(0,n.eI)(i,r);let o=()=>{let e=process.env.NEXT_PUBLIC_SUPABASE_URL,a=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!a)throw Error("Supabase environment variables not configured");return(0,n.eI)(e,a,{auth:{autoRefreshToken:!1,persistSession:!1}})}},6341:(e,a,t)=>{t.d(a,{db:()=>i}),global.__db_campaigns||(global.__db_campaigns=[],global.__db_campaign_uploads=[],global.__db_campaign_content_raw=[],global.__db_content_aliases=[],global.__db_genre_map=[],global.__db_initialized=!1);class n{constructor(){this.initializeDatabase()}async initializeDatabase(){try{global.__db_initialized?console.log("Database already initialized, reusing existing data"):(console.log("Initializing campaign-agnostic database..."),global.__db_initialized=!0,console.log("Database initialized successfully"))}catch(e){console.error("Database initialization error:",e)}}async createCampaign(e){if(!global.__db_initialized)throw Error("Database not yet initialized");let a=this.generateCampaignId(e),t={campaign_id:a,campaign_name:e,created_at:new Date};return global.__db_campaigns.push(t),console.log(`Created campaign: ${e} with ID: ${a}`),t}async getCampaigns(){return global.__db_initialized?(console.log(`Returning ${global.__db_campaigns.length} campaigns`),global.__db_campaigns.map(e=>({campaign_id:e.campaign_id,campaign_name:e.campaign_name,created_at:e.created_at}))):[]}async getCampaign(e){return global.__db_initialized&&global.__db_campaigns.find(a=>a.campaign_id===e)||null}async createCampaignUpload(e,a,t){if(!global.__db_initialized)throw Error("Database not yet initialized");let n={upload_id:this.generateUploadId(),campaign_id:e,filename:a,stored_path:t,uploaded_at:new Date};return global.__db_campaign_uploads.push(n),console.log(`Created upload for campaign ${e}: ${a}`),n}async getCampaignUploads(e){return global.__db_initialized?global.__db_campaign_uploads.filter(a=>a.campaign_id===e):[]}async insertCampaignContent(e){return global.__db_initialized?(global.__db_campaign_content_raw.push(...e),console.log(`Inserted ${e.length} content rows for campaign ${e[0]?.campaign_id}`),e.length):0}async upsertContentAlias(e,a){if(!global.__db_initialized)return;let t=global.__db_content_aliases.findIndex(a=>a.content_title_canon===e);t>=0?global.__db_content_aliases[t].content_key=a:global.__db_content_aliases.push({content_title_canon:e,content_key:a,created_at:new Date})}async upsertGenreMap(e,a){if(!global.__db_initialized)return;let t=global.__db_genre_map.findIndex(a=>a.raw_genre===e);t>=0?global.__db_genre_map[t].genre_canon=a:global.__db_genre_map.push({raw_genre:e,genre_canon:a,created_at:new Date})}generateAppRollup(e){if(!global.__db_initialized)return[];let a=e?global.__db_campaign_content_raw.filter(a=>a.campaign_id===e):global.__db_campaign_content_raw,t=new Map;for(let e of a){let a=e.content_network_name?.toLowerCase().trim()||"Unknown",n=`${e.campaign_id}-${a}`;t.has(n)||t.set(n,{campaign_id:e.campaign_id,app_name:e.content_network_name||"Unknown",impressions:0,completes:0,avg_vcr:0,content_count:0});let i=t.get(n);i.impressions+=e.impression||0,i.completes+=e.quartile100||0,i.content_count+=1}for(let e of Array.from(t.values()))e.avg_vcr=e.impressions>0?Math.round(e.completes/e.impressions*1e4)/100:0;let n=[],i=[];for(let e of Array.from(t.values()))e.impressions>=1e3?n.push(e):i.push(e);if(i.length>0){let a={campaign_id:e||"unknown",app_name:"Other",impressions:i.reduce((e,a)=>e+a.impressions,0),completes:i.reduce((e,a)=>e+a.completes,0),avg_vcr:0,content_count:i.reduce((e,a)=>e+a.content_count,0)};a.avg_vcr=a.impressions>0?Math.round(a.completes/a.impressions*1e4)/100:0,n.push(a)}return n.sort((e,a)=>a.impressions-e.impressions)}generateGenreRollup(e){if(!global.__db_initialized)return[];let a=e?global.__db_campaign_content_raw.filter(a=>a.campaign_id===e):global.__db_campaign_content_raw,t=new Map;for(let e of a){let a=this.getGenreCanon(e.content_network_name),n=`${e.campaign_id}-${a}`;t.has(n)||t.set(n,{campaign_id:e.campaign_id,genre_canon:a,impressions:0,completes:0,avg_vcr:0,content_count:0});let i=t.get(n);i.impressions+=e.impression||0,i.completes+=e.quartile100||0,i.content_count+=1}for(let e of Array.from(t.values()))e.avg_vcr=e.impressions>0?Math.round(e.completes/e.impressions*1e4)/100:0;return Array.from(t.values()).sort((e,a)=>a.impressions-e.impressions)}generateContentRollup(e){if(!global.__db_initialized)return[];let a=e?global.__db_campaign_content_raw.filter(a=>a.campaign_id===e):global.__db_campaign_content_raw,t=new Map;for(let e of a){let a=e.content_title||`${e.content_network_name} - Unknown Content`,n=this.getContentKey(a),i=e.content_network_name?.toLowerCase().trim()||"Unknown",r=`${e.campaign_id}-${n}-${i}`;t.has(r)||t.set(r,{campaign_id:e.campaign_id,content_key:n,content_title:a,content_network_name:e.content_network_name||"Unknown",impressions:0,completes:0,avg_vcr:0});let o=t.get(r);o.impressions+=e.impression||0,o.completes+=e.quartile100||0}for(let e of Array.from(t.values()))e.avg_vcr=e.impressions>0?Math.round(e.completes/e.impressions*1e4)/100:0;return Array.from(t.values()).sort((e,a)=>a.impressions-e.impressions)}generateCampaignId(e){let a=e.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,""),t=Math.random().toString(36).substring(2,8);return`${a}-${t}`}generateUploadId(){return`upload-${Date.now()}-${Math.random().toString(36).substring(2,8)}`}getContentKey(e){let a=e.toLowerCase().trim().replace(/[^a-z0-9 ]/g,""),t=global.__db_content_aliases.find(e=>e.content_title_canon===a);return t?.content_key||a}getGenreCanon(e){let a=global.__db_genre_map.find(a=>a.raw_genre===e);return a?.genre_canon||"Unknown"}getCampaignStats(e){global.__db_initialized;let a=global.__db_campaign_content_raw.filter(a=>a.campaign_id===e);a.reduce((e,a)=>e+(a.impression||0),0),a.reduce((e,a)=>e+(a.quartile100||0),0),new Set(a.map(e=>this.getGenreCanon(e.content_network_name))).size,a.length}async run(e,a=[]){if(!global.__db_initialized){console.log("Database not ready, query ignored:",e);return}console.log("Executing query:",e,"with params:",a)}async all(e,a=[]){return global.__db_initialized?console.log("Query ignored:",e):console.log("Database not ready, query ignored:",e),[]}async exec(e){if(!global.__db_initialized){console.log("Database not ready, query ignored:",e);return}console.log("Executing query:",e)}async close(){global.__db_campaigns=[],global.__db_campaign_uploads=[],global.__db_campaign_content_raw=[],global.__db_content_aliases=[],global.__db_genre_map=[],global.__db_initialized=!1}}let i=new n}};